---
title: "Hispanic Commute Modes"
output: html_document
fontsize: 12pt
---
\setmainfont{Poppins}
```{r setup, include=FALSE}
library(psrccensus)
library(ggplot2)
library(tidyverse)
library(psrcplot)
source("C:/Users/cpeak/Repos/equity-focused-trends/hisp_heritage/2023/hisp_functions.R")
library(sf) # geographic data library
library(psrcelmer) # to get data from Elmer
library(psrcplot) # to get color schemes
library(mapview) # for outputting the map to html or png
library(htmlwidgets) # to help with map formatting
library(leafsync)
library(scales)

pums_2021 <- get_psrc_pums(span = 5,
                           dyear = 2021,
                           level = "p",
                           vars = c("AGEP","PRACE",
                                    "MIG",           # lived here 1 year ago
                                    "HISP",          # detailed Hispanic origin
                                    "HISPEED",       # Has broadband internet
                                    "FACCESSP",      # Access to the Internet
                                    "HHLDRHISP",     # Detailed Hispanic origin of householder
                                    "RAC2P",         # race with country
                                    "ANC1P",         # Ancestry - first entry
                                    "JWTRNS",        # means of transportation to work
                                    "JWRIP",         # Vehicle occupancy in journey to work
                                    "JWMNP",         # Travel time to work
                                    "JWDP",          # Time of departure for work -- hour and minute
                                    "JWAP",          # Time of arrival at work -- hour and minute
                                    "NAICSP",        # NAICS recode for 2018
                                    "OCCP",          # Occupation recode based on 2018 OCC codes
                                    "POBP",          # Place of birth (Recode)
                                    "GRPIP",         # Gross rent as % of household income
                                    "OWN_RENT",      # Dichotomous tenure
                                    "MI_JOBSECTOR",  # PSRC-defined manufacturing-industrial groups
                                    "SOCP",          # Standard Occupational Classification (SOC) codes for 2018 and laterbased on 2018 SOC codes
                                    "TEN",           # Tenure
                                    "VEH",           # Vehicles (1 ton or less) available
                                    "WIF"))          # Workers in family



pums_2021 <- pums_2021 %>%
  hisp_pums_recode() %>%
  mutate(ind = substr(NAICSP, 1,3))


pums_race_counts <- pums_2021 %>%
  psrc_pums_count(., group_vars="race_4cat") 

```

``` {r prep_map, echo=FALSE, message=FALSE, warning=FALSE}

create_psrc_map <- function(lyr,
                            lyr_data_field,
                            legend_title,
                            legend_subtitle,
                            psrc_col_pal,
                            map_lat = 47.615,
                            map_lon = -122.257,
                            map_zoom = 8.5,
                            wgs84 = 4326) {
  # psrc colors need more contrast to work
  pal <-
    leaflet::colorNumeric(palette = psrc_col_pal, domain = lyr_data_field)
  
  css_fix <-
    "div.info.legend.leaflet-control br {clear: both;} html * {font-family: Poppins !important;}" # CSS to correct spacing and font family
  html_fix <-
    htmltools::tags$style(type = "text/css", css_fix)  # Convert CSS to HTML
  
  
  labels <-
    paste0('Estimate: ', prettyNum(round(lyr_data_field,-1), big.mark = ",")) %>%
    lapply(htmltools::HTML)
  
  m <- leaflet::leaflet() %>%
    leaflet::addMapPane(name = "polygons", zIndex = 410) %>%
    leaflet::addMapPane(name = "maplabels", zIndex = 500) %>% # higher zIndex rendered on top
    
    leaflet::addProviderTiles("CartoDB.VoyagerNoLabels") %>%
    leaflet::addProviderTiles(
      "CartoDB.VoyagerOnlyLabels",
      options = leaflet::leafletOptions(pane = "maplabels"),
      group = "Labels"
    ) %>%
    leaflet::addEasyButton(leaflet::easyButton(
      icon = htmltools::span(class = "globe", htmltools::HTML("&#127758;")),  #&#127760; (another emoji option) #"fa-globe", (font awesome icon no longer works because of the conversion to Poppins font below)  
      title ="Region",
      onClick=JS("function(btn, map){map.setView([47.615,-122.257],8.5); }")))%>%
    leaflet::addPolygons(
      data = lyr,
      fillOpacity = 0.7,
      fillColor = pal(lyr_data_field),
      weight = 0.7,
      color = "#BCBEC0",
      group = "estimate",
      opacity = 0,
      stroke = FALSE,
      options = leaflet::leafletOptions(pane = "polygons"),
      dashArray = "",
      highlight = leaflet::highlightOptions(
        weight = 5,
        color = "76787A",
        dashArray = "",
        fillOpacity = 0.7,
        bringToFront = TRUE
      ),
      label = labels,
      labelOptions = leaflet::labelOptions(
        style = list(
          "font-weight" = "normal",
          padding = "3px 8px",
          "font-family" = "Poppins"
        )
      )
    ) %>%
    
    leaflet::addLegend(
      pal = pal,
      values = lyr_data_field,
      position = "bottomright",
      title = paste(legend_title, '<br>', legend_subtitle)
    ) %>%
    
    leaflet::addLayersControl(baseGroups = "CartoDB.VoyagerNoLabels",
                              overlayGroups = c("Labels", "estimate")) %>%
    
    leaflet::setView(lng = map_lon, lat = map_lat, zoom = map_zoom) %>%
    htmlwidgets::prependContent(html_fix)      # Insert into leaflet HTML code
  
  return(m)
  
}
big_tbl<-read.csv('tract_accessibility_2018.csv')
tbl <- big_tbl %>% mutate(geoid10=as.character(tract_geoid10))
tract_layer_name <- "TRACT2010_NOWATER"
lyr <- st_read_elmergeo(tract_layer_name)
lyr_data<- dplyr::left_join(lyr,tbl, by="geoid10")
# this is the field to map
lyr_data_field<-lyr_data$access
# big_tbl <-psrccensus::get_acs_recs(geography='tract',table.names='B03001',year=2019, acs.type='acs5')
# hisp_tbl <- big_tbl %>%filter(label=='Estimate!!Total:!!Hispanic or Latino:')%>% 
#   dplyr::select(GEOID,estimate) %>%
#   dplyr::mutate(dplyr::across(c('GEOID'), as.character))%>%
#   dplyr::group_by(GEOID) %>%
#   dplyr::summarise(Total=sum(estimate))
# lyr_data_2<- dplyr::left_join(lyr_data,hisp_tbl, by = c("geoid10"='GEOID'))
lyr_data_2 <- lyr_data
# this is the field to map
lyr_data_field_2<-lyr_data_2$Total



```

``` {r hispanic_sov_share, echo=FALSE, cache=TRUE, warning=FALSE, message=FALSE}

hisp_sov <- get_acs_recs(geography='county', table.names='08105I', year=2021, acs.type='acs5') %>%
  filter(name == 'Region') %>%
  filter(!is.na(label)) %>%
  mutate(mode = sub(".*!!", "", label)) %>%
  filter(mode != 'Total:') %>%
  mutate(mode = case_when(
    grepl("drove alone", mode) ~ "SOV",
    grepl("carpooled", mode) ~ "HOV",
    grepl("Public transportation", mode) ~ "Transit",
    grepl("Taxicab", mode) ~ "Other",
    grepl("Worked from home", mode) ~ "At Home"
  )) %>%
  filter(!is.na(mode))

mode_chart_hisp_sov <- static_column_chart(
  t=hisp_sov, y="estimate", x='mode',
  fill='mode',
  color='psrc_light',
  moe='moe',
  title="Means of Transportation To Work, Hispanic Workers"
)
#mode_chart_hisp_sov


nonhisp_sov <- get_acs_recs(geography='county', table.names='08105H', year=2021, acs.type='acs5') %>%
  filter(name == 'Region') %>%
  filter(!is.na(label)) %>%
  mutate(mode = sub(".*!!", "", label)) %>%
  filter(mode != 'Total:') %>%
  mutate(mode = case_when(
    grepl("drove alone", mode) ~ "SOV",
    grepl("carpooled", mode) ~ "HOV",
    grepl("Public transportation", mode) ~ "Transit",
    grepl("Taxicab", mode) ~ "Other",
    grepl("Worked from home", mode) ~ "At Home"
  )) %>%
  filter(!is.na(mode))

mode_chart_nonhisp_sov <- static_column_chart(
  t=nonhisp_sov, y="estimate", x='mode',
  fill='mode',
  color='psrc_light',
  moe='moe',
  title="Means of Transportation To Work, Non-Hispanic Workers"
)
#mode_chart_nonhisp_sov
```
### Introduction
	
Nationally, Hispanic populations [report relatively high use of public transit](https://tinyurl.com/5n83ta2s) compared with non-Hispanic white people.  But in the central Puget Sound region, Census data shows that Hispanic workers report relatively low shares of transit commutes, roughly on par with their non-Hispanic white counterparts and at substantially lower rates than other groups.  We summarized the commute mode data available in the Census Bureau's 2017-2021 Public Use Microdata Sample (PUMS) by race and Hispanic origin:
```{r echo = FALSE, cache=TRUE, warning=FALSE, message=FALSE}
pums_mode <- pums_2021 %>%
  filter(mode_hts != "NA") %>%
  psrc_pums_count(., group_vars=c("race_4cat","mode_hts")) %>%
  filter(mode_hts != "Total") 

pums_mode_transit <- pums_mode %>%
  filter(mode_hts == 'Transit') %>%
  select(-mode_hts)

mode_chart_transit <- static_bar_chart(
  t=pums_mode_transit, x="share", y="race_4cat",
  fill="race_4cat",
  #facet="race_4cat",
  color='pognbgy_10',
  #moe="share_moe",
  title="Percent of Commuters Who Use Transit, By Race/Ethnicity",
  #ylabel="Race/Ethnicity",
  source='Source: 2017-2021 Census Public Use Microdata Sample'
) +
  theme(panel.grid.major.x = element_blank())

mode_chart_transit
```
Source: 2017-2021 Census Public Use Microdata Sample



```{r carpool echo = FALSE, cache=TRUE, warning=FALSE, message=FALSE}
pums_mode_carpool <- pums_mode %>%
  filter(mode_hts == 'Carpool')
  
mode_chart_carpool <- static_column_chart(
  t=pums_mode_carpool, y="share", x="mode_hts",
  fill="race_4cat",
  #facet="race_4cat",
  color='pognbgy_10',
  moe="share_moe",
  title="HOV Commute Mode Choice by Race"
)

mode_chart_carpool <- static_bar_chart(
  t=pums_mode_carpool, x="share", y="race_4cat",
  fill="race_4cat",
  #facet="race_4cat",
  color='pognbgy_10',
  #moe="share_moe",
  title="Percent of Commuters Who Carpool, By Race/Ethnicity",
  #ylabel="',
  source='Source: 2017-2021 Census Public Use Microdata Sample'
) +
  theme(panel.grid.major.x = element_blank())

mode_chart_carpool
```

This led us to wonder what are the factors that inform these choices, and what are some of the pressures that lead the area's Hispanic workers to favor cars over transit at higher rates than other populations.  

### Home Locations Make a Difference
First, we looked at the places that the Hispanic populace lives.  Using Census data from the 2021 5-year American Community Survey, we looked at the Hispanic population counts by tract.  As shown in the map below, large concentrations of Hispanic populations are in South King County -- notably Burien, Des Moines, Federal Way and Auburn -- and Southern Snohomish County along the SR 99 Corridor.  

```{r transit_access_map, echo = FALSE, cache=TRUE, warning=FALSE, message=FALSE}
# create Census data layer 
census_tbl <-psrccensus::get_acs_recs(geography='tract',table.names='B03001',year=2021, acs.type='acs5')
hisp_tbl <- census_tbl %>%filter(label=='Estimate!!Total:!!Hispanic or Latino:')%>% 
  dplyr::select(GEOID,estimate) %>%
  dplyr::mutate(dplyr::across(c('GEOID'), as.character))%>%
  dplyr::group_by(GEOID) %>%
  dplyr::summarise(Total=sum(estimate))
lyr20 <- st_read_elmergeo("TRACT2020_NOWATER")
lyr_data_census <- dplyr::left_join(lyr20, hisp_tbl, by = c("geoid20"='GEOID'))
lyr_data_census_field <- lyr_data_census$Total

psrc_orange_plus<-append(psrc_colors$oranges_inc, "#FFFFFF", after=0)

map_hisp_pop<-create_psrc_map(lyr=lyr_data_census, 
                       lyr_data_field=lyr_data_census_field,
                       legend_title= 'Hispanic Population',
                       legend_subtitle = 'ACS 2017-2021 5-year',
                       psrc_col_pal=psrc_orange_plus)

 map_hisp_pop
 mapshot(map_hisp_pop, file='hisp_pop.png')
```

To see how well commuters in these areas of high Hispanic concentrations are served by transit, we calculated the number of jobs accessible by transit within 45 minutes for each Census tract. This map, below, shows that the areas with best transit access to jobs are concentrated in central Seattle and Bellevue.  Residents in these areas can reach a large pool of jobs by a 45-minute transit ride -- nearly 800,000 for some tracts.  By contrast, people living in the areas of high Hispanic populations can reach a much smaller pool by equivalent means: many can reach only between 30 and 60 thousand within the same 45-minute window.  Residents of the tract with the single highest Hispanic population, in Auburn, have only 20,000 jobs accessible within this window  And the fewer the jobs accessible by transit, the higher the likelihood that a given worker will need to drive to get to his or her place of work.

```{r hispanic_pop_map, echo = FALSE, cache=TRUE, warning=FALSE, message=FALSE}

psrc_purple_plus<-append(psrc_colors$purples_inc, "#FFFFFF", after=0)
map_acc<-create_psrc_map(lyr=lyr_data_2,
                        lyr_data_field=lyr_data_field,
                        legend_title= 'Transit Accessibility',
                        legend_subtitle = 'Number of Jobs within 45 minutes on Transit',
                        psrc_col_pal=psrc_purple_plus)

map_acc
mapshot(map_acc, file='map_acc.png')


```

The effects of the lower levels of transit accessibility for Hispanic workers can be seen not only in the lower use of transit as documented above, but also in high carpooling rates among this group.  Hispanic workers are twice as likely to commute by carpool as non-Hispanic white workers: The rates for these two groups are 14% and 7%, respectively.  A full investigation into the factors that might be influencing this is beyond the scope of this article, but it seems likely that this might be a response to less accessible transit commute options for Hispanic workers.  

	
### Not All Occupations Are Equally Well-Suited to Transit

Some occupations are better suited to transit than others.  In the Census data we looked at (the 2017-2021 PUMS) we found that construction work is the most common occupation for the region's Hispanic workers, at 11% of Hispanic employment.  This is a much higher rate than it is for non-Hispanic workers, for whom it ranks eleventh, at 4% .  The share of construction workers of any race or ethnicity who commute by transit is very low -- only 2%.  It has been pointed out in [the news media](https://www.seattletimes.com/seattle-news/data/these-three-occupations-use-public-transit-far-more-than-most-in-king-county/) that these jobs often do not lend themselves well to transit because the work often require tools or equipment to be carried to the job site.  As this occupation represents such a comparatively large share of Hispanic workers, it is likely that this is another contributor to the relatively low transit commute share for this group.

<!--Food Preparation and Serving is the second-highest occupation for Hispanic workers, at 10.8%, which is roughly double the rate for non-Hispanic workers (5% ).  The transit commute share for this occupation (8%) is much higher than it is for construction, which is on par with the overall regional share for all occupations and demographic groups.  It thus does not seem to be a contributor to the comparatively lower transit commute share for Hispanic workers the way construction does. -->

Food Preparation and Service, the second-highest occupation for Hispanic workers (10.8%) does not appear to be a significant contributor to low transit commute rates but the third-highest, Building and Grounds Cleaning and Maintenance does.  Eight percent of Hispanic workers are in this latter category, compared with only 2% for non-Hispanic workers.  As with construction, workers in this occupation tend to commute by transit at relatively low rates (5%), so this is likely to reduce Hispanic transit commute shares further.  It is worth noting that these occupations often lend themselves to evening and night shifts, and may be less well served by most transit routes for this reason.

```{r transit_commutes_by_occupation, echo = FALSE, cache=TRUE, warning=FALSE, message=FALSE}

# transit mode choice: by occupation
pums_transit_occ <- pums_2021 %>%
  mutate(occupation = case_when(
    occupation == "CON" ~ "Construction",
    occupation == "EAT" ~ "Food Service",
    occupation == "CLN" ~ "Cleaning and Maintenance",
    TRUE ~ occupation
  )) %>%
  psrc_pums_count(., group_vars=c("occupation","mode_hts")) %>%
  filter(mode_hts == "Transit") %>%
  filter(mode_hts != "Total")%>%
  arrange(desc(share))%>%
  #filter(occupation2 %in% c("MGR", "OFF", "SAL", "CMM", "TRN","EDU", "EAT", "MED", "CON"))%>%
  #filter(occupation2 %in% c("CON", "EAT", "CLN", "OFF"))%>%
  filter(occupation %in% c("Construction", "Food Service", "Cleaning and Maintenance"))%>%
  mutate(occupation=factor(occupation, levels=unique(occupation)))

occ_mode_chart <-  ggplot(pums_transit_occ,aes(x=occupation, y=share))+
  geom_bar(stat="identity", fill="#F05A28" , position=position_dodge())+ 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe), width=0.2,
                     position=position_dodge(.9))

#occ_mode_chart

```

It should be stressed that the effect of these occupations on the overall transit commute shares for Hispanic workers is likely to be relatively minor in comparison with the misalignment between transit services and Hispanic home locations that was discussed in the previous section.  After all, Construction, Grounds Cleaning and Maintenance work represent only 20% of overall Hispanic employment, and can explain only so much.  But the effects of the prevalence of the occupations do seem to be secondary contributing factors to the relatively low Hispanic commute shares.  


### Conclusion

The relatively low rate of transit commute trips among Hispanic workers appears to be tied to several factors.  Residence location, transit infrastructure, and occupation types all have their effects on the transit commute mode share for Hispanic workers.  In particular, the misalignment of transit services with the areas in the region that many Hispanic workers live points to an opportunity: More targeted transit investments in these areas would benefit Hispanic commuters and would contribute to a more equitable system overall.  Further investments to better accommodate people working throughout all times of day would enhance equity in the system even more.









```{r commutes_by_race_cn, echo = FALSE, cache=TRUE, warning=FALSE, message=FALSE}

pums_mode_cn <- pums_2021 %>%
  filter(mode_hts != "NA") %>%
  filter(grepl('Construction', NAICSP)) %>%
  psrc_pums_count(., group_vars=c("race_4cat","mode_hts")) %>%
  filter(mode_hts != "Total") 
  
# mode_chart_cn_drive <- interactive_column_chart(
#   t=pums_mode_cn %>% filter(mode_hts == 'Drive'), 
#   y="share", x="mode_hts",
#   fill="race_4cat",
#   #facet="race_4cat",
#   color='pognbgy_10',
#   moe="share_moe",
#   title="Drive Commute Mode choice by Race: Construction Only"
# )

# mode_chart_cn_drive
```

```{r mode_choices, echo = FALSE, cache=TRUE, warning=FALSE, message=FALSE}

# overall commute mode shares
pums_commute_modes <- pums_2021 %>%
  filter(mode_hts != "NA") %>%
  psrc_pums_count(., group_vars=c("mode_hts")) %>%
  filter(mode_hts != "Total")%>%
  arrange(desc(share))%>%
  #filter(occupation2 %in% c("MGR", "OFF", "SAL", "CMM", "TRN","EDU", "EAT", "MED", "CON"))%>%
  #filter(occupation2 %in% c("CON", "EAT", "CLN", "OFF"))%>%
  mutate(mode_hts=factor(mode_hts, levels=unique(mode_hts)))

commute_mode_chart <-  ggplot(pums_commute_modes,aes(x=mode_hts, y=share))+
  geom_bar(stat="identity", fill="#8f34eb" , position=position_dodge())+ 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  geom_errorbar(aes(ymin=share-share_moe, ymax=share+share_moe), width=0.2,
                     position=position_dodge(.9))

#commute_mode_chart


# show shifts by occupation
pums_occ_shift <- pums_2021 %>%
  #filter(occupation == 'CLN') %>%
  filter(grepl("Hispanic", race_4cat)) %>%
  filter(mode_hts != "NA") %>%
  filter( !is.na(shift)) %>%
  psrc_pums_count(., group_vars=c("shift", "mode_hts")) %>%
  filter(mode_hts != "Total")%>%
  arrange(desc(share))
  

occ_chart_shifts <- static_column_chart(
  t=pums_occ_shift,
  y="share", x="mode_hts",
  fill="shift",
  #facet="race_4cat",
  color='pognbgy_10',
  moe="share_moe",
  title="Commute Modes by Shift"
)


```




