---
output: 
  pdf_document:
    latex_engine: lualatex
fontsize: 12pt
  
header-includes:
  - \usepackage{xcolor}
  - \usepackage{hyperref}
  - \usepackage{pdfcomment}
  - \usepackage{fancyhdr}
   \pagestyle{fancy}
   \setlength{\headheight}{75pt}
   \setlength{\textheight}{600pt}
   \fancyhead[C]{}
   \fancyhead[L]{\includegraphics{X:/DSA/shiny-uploads/images/PST_Equity_Edition-Trend_header.png}}
   \fancyhead[R]{}
   \fancyfoot[L]{\scriptsize{1011 Western Ave, Suite 500, Seattle WA 98104} \textcolor[HTML]{F05A28}. 206.464.7532 \textcolor[HTML]{F05A28}. www.psrc.org \textcolor[HTML]{F05A28}. November 2022}
   \fancyfoot[R]{\textcolor[HTML]{F05A28}\thepage}
   \fancyfoot[C]{}
   \renewcommand{\headrulewidth}{0pt}
   \renewcommand{\footrulewidth}{4pt}
   \renewcommand{\footrule}{\hbox to \headwidth{\color[HTML]{BCBEC0}\leaders\hrule height \footrulewidth\hfill}}
  - \usepackage{fontspec}

---
\setmainfont{Poppins}

# Celebrating Native American Heritage Month

```{r setup, include=FALSE}
library(psrcplot)
library(psrccensus)
library(tidyverse)
library(knitr)
library(magick)
library(openxlsx)

# File name for Trend Data file to be created
xlsx_file <- "trend-equity-202211.xlsx"

# Create Image 
image1 <- image_read("X:/DSA/shiny-uploads/images/51391430801_092ce43bba_o.jpg")
image2 <- image_read("X:/DSA/shiny-uploads/images/Indigenous_Peoples_Day_Art.jpg")
image3 <- image_read("X:/DSA/shiny-uploads/images/51416961685_dc61029903_o.jpg")

input <- c(image_scale(image1, "x200"), image_scale(image2, "x200"), image_scale(image3, "x200"))

trend_image_header <- image_append(input)
image_write(trend_image_header, path="trend_image_header.png", format="png")

install_psrc_fonts()

create_static_bar_chart <- function(t, x, y, fill,
                                    pos="dodge", est="percent", moe=NULL,
                                    href=NULL, hrefnm=NULL, hrefcl=NULL,
                                    title="", subtitle="", source="", alt="", 
                                    dec = 0, color="psrc_dark") {
  
  # Determine the Maximum Value to ensure bar labels are not cut-off
  max_item <- t %>% dplyr::select(.data[[y]]) %>% pull() %>% max()
  
  # Create a color palette from PSRC palette
  grps <- t %>% dplyr::select(.data[[fill]]) %>% unique() %>% dplyr::pull()
  num.grps <- length(grps)
  l.colors <- unlist(psrcplot::psrc_colors[color])
  l.colors <- l.colors[1:num.grps]
  cols <- stats::setNames(l.colors, grps)
  
  # Estimate type determines the labels for the axis and the format of the number for the hover-text
  if (est=="percent") {
    scale_max <- max_item * 1.25
    fac=100
    p=""
    s="%"
    lab=scales::label_percent()
    annot = 0.01
    
  } else if (est=="currency") {
    scale_max <- max_item * 1.25
    fac=1
    p="$"
    s=""
    lab=scales::label_dollar()
    annot = 1
    
  } else {
    scale_max <- max_item * 1.25
    fac=1
    p=""
    s=""
    lab=scales::label_comma()
    annot = 1
  }
  
  # First Create the Static Chart
  c <- ggplot2::ggplot(data=t,
                       ggplot2::aes(x=get(eval(x)),
                                    y=get(eval(y)),
                                    text=paste0(get(eval(fill)), ": ", p, prettyNum(round(get(eval(y))*fac, dec), big.mark = ","),s),
                                    fill = get(eval(fill)))) +
    ggplot2::geom_bar(position=pos, stat="identity") +
    ggplot2::scale_fill_manual(values=cols)  +
    ggplot2::scale_y_continuous(labels = lab, limits = c(0, scale_max), expand = c(0, 0)) +
    #ggplot2::labs(title=title, subtitle = subtitle, caption = source, alt = alt) +
    ggplot2::labs(title=title, caption = source, alt = alt) +
    psrcplot::psrc_style()
  
  # If there is a MOE value then error bars are added to the plot
  if (!(is.null(moe))) {
    c <- c + ggplot2::geom_errorbar(ggplot2::aes(ymin=get(eval(y))-get(eval(moe)), ymax=get(eval(y))+get(eval(moe))),width=0.2, position = ggplot2::position_dodge(0.9))
  }
  
  # Add reference lines if they are included 
  if (!(is.null(href))) {
    c <- c + 
      ggplot2::geom_hline(yintercept = href, color=hrefcl, linetype='solid', size=2, show.legend = FALSE) +
      ggplot2::annotate("text", x = 1, y = href+annot, label = hrefnm)
  }
  
  if (num.grps == 1) {
    
    c <- c + ggplot2::theme(legend.position = "none")
    
  }
  
  c <- c + ggplot2::theme(

    #Text format:
    #This sets the font, size, type and color of text for the chart's title
    plot.title = ggplot2::element_text(family="Poppins",
                                       size=14),

    #This sets the font, size, type and color of text for the chart's subtitle, as well as setting a margin between the title and the subtitle
    #plot.subtitle = ggplot2::element_text(family="Poppins",
    #                                      size=11,
    #                                      margin=ggplot2::margin(9,0,9,0)),

    #This leaves the caption text element empty, because it is set elsewhere in the finalise plot function
    plot.caption =  ggplot2::element_text(family="Poppins",
                                          size=10,
                                          face="italic",
                                          color="#4C4C4C"))
  c <- c + ggplot2::coord_flip()
  
  # Add Bar Labels if there is no Error Bar
  if (is.null(moe)) {
    c <- c + ggplot2::geom_text(aes(x=get(eval(x)), 
                                    y=get(eval(y)), 
                                    label=paste0(p,prettyNum(round(get(eval(y))*fac,dec), big.mark = ","),s)),
                                check_overlap = TRUE,
                                position = position_dodge(0.9),
                                hjust = -0.1,
                                size = 11*0.36,
                                family="Poppins")
  }
  
  return(c)
}

create_static_column_chart <- function(t, x, y, fill,
                                       pos="dodge", est="percent", moe=NULL,
                                       href=NULL, hrefnm=NULL, hrefcl=NULL,
                                       title="", subtitle="", source="", alt="", 
                                       dec = 0, color="psrc_dark") {
  
  # Determine the Maximum Value to ensure bar labels are not cut-off
  max_item <- t %>% dplyr::select(.data[[y]]) %>% pull() %>% max()
  
  # Create a color palette from PSRC palette
  grps <- t %>% dplyr::select(.data[[fill]]) %>% unique() %>% dplyr::pull()
  num.grps <- length(grps)
  l.colors <- unlist(psrcplot::psrc_colors[color])
  l.colors <- l.colors[1:num.grps]
  cols <- stats::setNames(l.colors, grps)
  
  # Estimate type determines the labels for the axis and the format of the number for the hover-text
  if (est=="percent") {
    scale_max <- max_item * 1.1
    fac=100
    p=""
    s="%"
    lab=scales::label_percent()
    annot = 0.01
    
  } else if (est=="currency") {
    scale_max <- max_item * 1.1
    fac=1
    p="$"
    s=""
    lab=scales::label_dollar()
    annot = 1
    
  } else {
    scale_max <- max_item * 1.1
    fac=1
    p=""
    s=""
    lab=scales::label_comma()
    annot = 1
  }
  
  # First Create the Static Chart
  c <- ggplot2::ggplot(data=t,
                       ggplot2::aes(x=get(eval(x)),
                                    y=get(eval(y)),
                                    text=paste0(get(eval(fill)), ": ", p, prettyNum(round(get(eval(y))*fac, dec), big.mark = ","),s),
                                    fill = get(eval(fill)))) +
    ggplot2::geom_bar(position=pos, stat="identity") +
    ggplot2::scale_fill_manual(values=cols)  +
    ggplot2::scale_y_continuous(labels = lab, limits = c(0, scale_max), expand = c(0, 0)) +
    #ggplot2::labs(title=title, subtitle = subtitle, caption = source, alt = alt) +
    ggplot2::labs(title=title, caption = source, alt = alt) +
    psrcplot::psrc_style()
  
  # If there is a MOE value then error bars are added to the plot
  if (!(is.null(moe))) {
    c <- c + ggplot2::geom_errorbar(ggplot2::aes(ymin=get(eval(y))-get(eval(moe)), ymax=get(eval(y))+get(eval(moe))),width=0.2, position = ggplot2::position_dodge(0.9))
  }
  
  # Add Bar Labels if there is no Error Bar
  if (is.null(moe)) {
    c <- c + ggplot2::geom_text(aes(x=get(eval(x)), 
                                    y=get(eval(y)), 
                                    label=paste0(p,prettyNum(round(get(eval(y))*fac,dec), big.mark = ","),s)),
                                check_overlap = TRUE,
                                position = position_dodge(0.9),
                                vjust = -0.25,
                                size = 11*0.36,
                                family="Poppins")
  }
  
  # Add reference lines if they are included 
  if (!(is.null(href))) {
    c <- c + 
      ggplot2::geom_hline(yintercept = href, color=hrefcl, linetype='solid', size=2, show.legend = FALSE) +
      ggplot2::annotate("text", x = 1, y = href+annot, label = hrefnm)
  }
  
  if (num.grps == 1) {
    
    c <- c + ggplot2::theme(legend.position = "none")
    
  }
  
  c <- c + ggplot2::theme(

    #Text format:
    #This sets the font, size, type and color of text for the chart's title
    plot.title = ggplot2::element_text(family="Poppins",
                                       size=14),

    #This sets the font, size, type and color of text for the chart's subtitle, as well as setting a margin between the title and the subtitle
    #plot.subtitle = ggplot2::element_text(family="Poppins",
    #                                      size=11,
    #                                      margin=ggplot2::margin(9,0,9,0)),

    #This leaves the caption text element empty, because it is set elsewhere in the finalise plot function
    plot.caption =  ggplot2::element_text(family="Poppins",
                                          size=10,
                                          face="italic",
                                          color="#4C4C4C"))

  return(c)
}

create_static_treemap_chart <- function(t, area, fill, title="", subtitle="", source="", alt="", est="percent", dec=0, color="psrc_light") {
  
  tot <- t %>% dplyr::select(.data[[area]]) %>% dplyr::pull() %>% sum()
  t <- t %>% dplyr::mutate(total_share = .data[[area]]/tot)
  
  # Estimate type determines the labels
  if (est=="percent") {
    factor=100
    p=""
    s="%"
    
  } else if (est=="currency") {
    factor=1
    p="$"
    s=""
    
  } else {
    factor=1
    p=""
    s=""
  }
  
  if (est=="percent") {
    c <- ggplot2::ggplot(t,
                         ggplot2::aes(area = get(eval(area)),
                                      fill = get(eval(fill)), 
                                      label = paste(get(eval(fill)), 
                                                    paste0(p, prettyNum(round(get(eval(area))*factor,dec), big.mark = ","), s),
                                                    sep = "\n"))) +
      treemapify::geom_treemap(colour = "white", size = 3) +
      treemapify::geom_treemap_text(colour = "white",
                                    place = "centre",
                                    size = 16,
                                    grow = FALSE,
                                    fontface="bold") +
      psrc_style() +
      ggplot2::theme(legend.position = "none") +
      scale_fill_discrete_psrc(color) +
      #ggplot2::labs(title=expr(underline(!!title)), subtitle = subtitle, caption = source, alt = alt)
      ggplot2::labs(title=title, caption = source, alt = alt)
    
  } else {
    
    c <- ggplot2::ggplot(t,
                         ggplot2::aes(area = get(eval(area)),
                                      fill = get(eval(fill)), 
                                      label = paste(get(eval(fill)), 
                                                    paste0(p, prettyNum(round(get(eval(area))*factor,dec), big.mark = ","), s),
                                                    #paste0(prettyNum(round(.data$total_share*100,0), big.mark = ","), "%"), 
                                                    sep = "\n"))) +
      treemapify::geom_treemap(colour = "white", size = 3) +
      treemapify::geom_treemap_text(colour = "white",
                                    place = "centre",
                                    size = 16,
                                    grow = FALSE,
                                    fontface="bold") +
      psrc_style() +
      ggplot2::theme(legend.position = "none") +
      scale_fill_discrete_psrc(color) +
      #ggplot2::labs(title=expr(underline(!!title)), subtitle = subtitle, caption = source, alt = alt) +
      #ggplot2::labs(title=title, subtitle = subtitle, caption = source, alt = alt)
      ggplot2::labs(title=title, caption = source, alt = alt)
    
  }
  
    c <- c + ggplot2::theme(

    #Text format:
    #This sets the font, size, type and color of text for the chart's title
    plot.title = ggplot2::element_text(family="Poppins",
                                       size=14),

    #This sets the font, size, type and color of text for the chart's subtitle, as well as setting a margin between the title and the subtitle
    #plot.subtitle = ggplot2::element_text(family="Poppins",
    #                                      size=11,
    #                                      margin=ggplot2::margin(9,0,9,0)),

    #This leaves the caption text element empty, because it is set elsewhere in the finalise plot function
    plot.caption =  ggplot2::element_text(family="Poppins",
                                          size=10,
                                          face="italic",
                                          color="#4C4C4C"))
  
  return(c)
}

create_static_line_chart <- function(t, x, y, fill, 
                                     title="", subtitle="", source="", alt="", 
                                     est="number", dec=0, xtype="Date", dform="%b-%Y", 
                                     breaks=NULL, lwidth=1, color="psrc_light") {
  
  # Determine the Maximum Value to ensure bar labels are not cut-off
  max_item <- t %>% dplyr::select(.data[[y]]) %>% pull() %>% max()
  
  # Create a color palette from PSRC palette
  grps <- t %>% dplyr::select(.data[[fill]]) %>% unique() %>% dplyr::pull()
  num.grps <- length(grps)
  l.colors <- unlist(psrcplot::psrc_colors[color])
  l.colors <- l.colors[1:num.grps]
  cols <- stats::setNames(l.colors, grps)
  
  # Estimate type determines the labels for the axis and the format of the number for the hover-text
  if (est=="percent") {
    scale_max <- max_item * 1.1
    fac=100
    p=""
    s="%"
    lab=scales::label_percent()
    annot = 0.01
    
  } else if (est=="currency") {
    scale_max <- max_item * 1.1
    fac=1
    p="$"
    s=""
    lab=scales::label_dollar()
    annot = 1
    
  } else {
    scale_max <- max_item * 1.1
    fac=1
    p=""
    s=""
    lab=scales::label_comma()
    annot = 1
  }
  
    if (xtype=="Continuous") {
      g <- ggplot2::ggplot(data=t, 
                           ggplot2::aes(x=get(eval(x)),
                                        y=get(eval(y)), 
                                        group=get(eval(fill))))  + 
        ggplot2::geom_line(ggplot2::aes(color=get(eval(fill))), size=lwidth, linejoin = "round") +
        ggplot2::geom_point(ggplot2::aes(color=get(eval(fill))))+
        ggplot2::scale_x_discrete(breaks=breaks) +
        ggplot2::scale_y_continuous(labels = lab) +
        ggplot2::scale_color_manual(values=cols)  +
        #ggplot2::labs(title=title, subtitle = subtitle, caption = source, alt = alt) +
        ggplot2::labs(title=title, caption = source, alt = alt) +
        psrc_style()
      
    } else {
      
      g <- ggplot2::ggplot(data=t, 
                           ggplot2::aes(x=get(eval(x)),
                                        y=get(eval(y)), 
                                        group=get(eval(fill))))  + 
        ggplot2::geom_line(ggplot2::aes(color=get(eval(fill))), size = lwidth, linejoin = "round") +
        ggplot2::scale_x_date(labels = scales::date_format(dform)) +
        ggplot2::scale_y_continuous(labels = lab) +
        ggplot2::scale_color_manual(values=cols)  +
        #ggplot2::labs(title=title, subtitle = subtitle, caption = source, alt = alt) +
        ggplot2::labs(title=title, caption = source, alt = alt) +
        psrc_style()
      
    }
  
      g <- g + ggplot2::theme(

    #Text format:
    #This sets the font, size, type and color of text for the chart's title
    plot.title = ggplot2::element_text(family="Poppins",
                                       size=14),

    #This sets the font, size, type and color of text for the chart's subtitle, as well as setting a margin between the title and the subtitle
    #plot.subtitle = ggplot2::element_text(family="Poppins",
    #                                      size=11,
    #                                      margin=ggplot2::margin(9,0,9,0)),

    #This leaves the caption text element empty, because it is set elsewhere in the finalise plot function
    plot.caption =  ggplot2::element_text(family="Poppins",
                                          size=10,
                                          face="italic",
                                          color="#4C4C4C"))
  
  return(g)
}

# Load Data or Generate if not already processed
if(file.exists("aian_hertitage_data.csv")) {
  data <- read.csv("aian_hertitage_data.csv") %>% mutate(year=as.character(year)) %>% mutate(race = str_wrap(race, width = 20))
} else {
  source("data-processing.R")
  data <- read.csv("aian_hertitage_data.csv") %>% mutate(year=as.character(year)) %>% mutate(race = str_wrap(race, width = 20))
}

# Rename a few items
data <- data %>% 
  mutate(race = str_replace_all(race, "White", "white")) %>%
  mutate(label = str_replace_all(label, "All other American Indian Tribes with only one Tribe reported", "All Other Tribes with only one Tribe reported")) %>%
  mutate(label = str_replace_all(label, "American Indian and Alaska Native Tribes where Tribe Not Specified", "Tribe Not Specified")) %>%
  mutate(label = str_replace_all(label, "American Indian Tribes with fewer than 1000 people", "Tribes with fewer than 1000 people")) %>%
  mutate(label = str_replace_all(label, "Two or More American Indian and Alaska Native Tribes", "Two or More Tribes")) %>%
  select(-X)

```

![](trend_image_header.png){width=100%}

```{r tribal-groupings-calculation, include=FALSE}

tbl <- data %>%
  filter(concept=="Tribal Groupings" & year=="2020") %>%
  arrange(desc(estimate)) %>%
  mutate(label=str_wrap(label,width=20))
  
tbl_order <- tbl %>% select(label) %>% pull()
tbl <- tbl %>% mutate(label = factor(x=label, levels=tbl_order))

ps_salish <- tbl %>% filter(label=="Puget Sound Salish") %>% select(estimate) %>% pull()

# Create Visuals
tribal_groupings_chart <- create_static_treemap_chart(t = tbl, area="estimate", fill="label", est="number", dec=-1,
                                                      title = "Tribal Groupings With 1,000 or More Population",
                                                      source = paste("Source: U.S. Census Bureau, 2016-2020 ACS 5-Year Estimates, Table B02014",
                                                                     "for King, Kitsap, Pierce and Snohomish counties.",
                                                                    sep = "\n"),
                                                      color = "gnbopgy_10") + 
  ggplot2::theme(axis.text.x = ggplot2::element_blank(),
                 axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank(),
                 legend.text = ggplot2::element_text(family="Poppins",
                                        size=10,
                                        color="#4C4C4C")) 

ggsave("tribal_groupings_chart.png", tribal_groupings_chart, width = 8, height = 5, dpi = 96)

rm(tbl)
```

\begin{flushleft}
This month, PSRC delves into data on the region’s American Indian and Alaska Native population. People with First Nations heritage in our region are very diverse, with over 50 Tribal groups represented. About \textbf{`r toString(prettyNum(round(ps_salish,-2), big.mark = ","))`} of the region’s residents identify as Puget Sound Salish. The American Community Survey groups Tribes who have original homelands in the four-county region under the name Puget Sound Salish. The region’s second most common Tribal grouping is Tlingit-Haida, who are Alaska Native peoples. 
\end{flushleft}

\pdftooltip{\includegraphics{tribal_groupings_chart.png}}{Number of people by Tribal Grouping with more than 1000 people in the Puget Sound Region}

\href{https://data.census.gov/cedsci/table?q=B02014&g=0500000US53033,53035,53053,53061&tid=ACSDT5Y2020.B02014&hidePreview=true}{\underline{\textcolor{blue}{View the full data set here}}}

\newpage

\setlength{\headheight}{25pt}
\setlength{\textheight}{650pt}
\fancyhead[L]{}

## Wealth & Income Disparities

\begin{flushleft}
PSRC celebrates the diverse, rich cultures of people with American Indian and Alaska Native heritage. We also recognize the suffering that members of these groups have experienced in the past and continue to endure due to historical policies and practices. Economic inequities persist for people with American Indian and Alaska Native heritage and lead to disparities in income and home ownership.  
\end{flushleft}

```{r income-calculation, include=FALSE}

aian_income_2015 <- data %>% filter(concept=="Median Income" & year=="2015" & race=="American Indian and\nAlaska Native") %>% select(estimate) %>% pull()
aian_income_2020 <- data %>% filter(concept=="Median Income" & year=="2020" & race=="American Indian and\nAlaska Native") %>% select(estimate) %>% pull()

white_income_2015 <- data %>% filter(concept=="Median Income" & year=="2015" & race=="white") %>% select(estimate) %>% pull()
white_income_2020 <- data %>% filter(concept=="Median Income" & year=="2020" & race=="white") %>% select(estimate) %>% pull()

aian_ratio_2015 <- aian_income_2015/white_income_2015
aian_ratio_2020 <- aian_income_2020/white_income_2020

aian_income <- prettyNum(round(aian_income_2020,-2), big.mark = ",")
aian_income_share <- prettyNum(round(aian_ratio_2020*100,0), big.mark = ",")

# Arrange by Race
tbl <- data %>% filter(concept=="Median Income") %>% arrange(desc(race))
tbl_order <- tbl %>% select(race) %>% distinct %>% pull()
tbl <- tbl %>% mutate(race = factor(x=race, levels=tbl_order))

median_income_chart <- create_static_bar_chart(t = tbl,
                                               x = "race", y = "estimate", fill = "year", est = "currency", dec = -3,
                                               title = "Median Annual Household Income",
                                               source = paste("Source: U.S. Census Bureau, Public Use Microdata Sample 5-Year Estimates, variable HINCP",
                                                              "for King, Kitsap, Pierce and Snohomish counties.",
                                                              sep = "\n"),
                                               color = "gnbopgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 axis.text.x = ggplot2::element_blank(),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.title.position = "plot",
                 plot.caption.position = "plot",
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_blank(),
                 axis.line.y = ggplot2::element_line(color="#cbcbcb"))

ggsave("median_income_chart.png", median_income_chart, width = 8, height = 6, dpi = 86)
  
```

\begin{flushleft}
Between 2015 and 2020, incomes grew for both American Indian and Alaska Native households and white ones. Despite growing slightly faster than white households, the 2020 Median Annual Income for an American Indian and Alaska Native household of \$`r aian_income` was still `r aian_income_share`\% that of a white household. 
\end{flushleft}

\pdftooltip{\includegraphics{median_income_chart.png}}{Median annual household income for people who identify as American Indian and Alaska Native or white}

\newpage

```{r poverty-calculation, include=FALSE}

aian_poverty_2015 <- data %>% filter(concept=="Poverty" & year=="2015" & race=="American Indian and\nAlaska Native") %>% select(share) %>% pull()
aian_poverty_2020 <- data %>% filter(concept=="Poverty" & year=="2020" & race=="American Indian and\nAlaska Native") %>% select(share) %>% pull()

white_poverty_2015 <- data %>% filter(concept=="Poverty" & year=="2015" & race=="white") %>% select(share) %>% pull()
white_poverty_2020 <- data %>% filter(concept=="Poverty" & year=="2020" & race=="white") %>% select(share) %>% pull()

aian_ratio_2015 <- aian_poverty_2015/white_poverty_2015
aian_ratio_2020 <- aian_poverty_2020/white_poverty_2020

aian_poverty <- prettyNum(round(aian_poverty_2020*100,0), big.mark = ",")
aian_poverty_share <- prettyNum(round(aian_ratio_2020,1), big.mark = ",")

poverty_chart <- create_static_column_chart(t = data %>% filter(concept == "Poverty"),
                                            x = "race", y = "share", fill = "year",
                                            title = "Percentage of Households Experiencing Poverty",
                                            source = paste("Source: U.S. Census Bureau, 2016-2020 ACS 5-Year Estimates, tables B17020H, B17020C", 
                                                           "for King, Kitsap, Pierce and Snohomish counties.",
                                                                          sep = "\n"),
                                            color = "pgnobgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank()) 

ggsave("poverty_chart.png", poverty_chart, width = 8, height = 6, dpi = 86)

```

\begin{flushleft}
Similar to median incomes, the percentage of American Indian and Alaska Native households living in poverty decreased to `r aian_poverty`\% in 2020 but it is still `r aian_poverty_share` times the rate for white households. The Federal poverty level (FPL) is a measure of income issued every year by the Department of Health and Human Services (HHS) and are used to determine eligibility for certain programs and benefits, including savings on Marketplace health insurance, and Medicaid and CHIP coverage. The FPL varies by household size and was \$26,500 for a family of four in 2020.
\end{flushleft}

\pdftooltip{\includegraphics{poverty_chart.png}}{Percentage of households below the federal poverty line for people who identify as American Indian and Alaska Native or white}

```{r educational-attainment-calculation, include=FALSE}

aian_education_2015 <- data %>% filter(concept=="Educational Attainment" & year=="2015" & race=="American Indian and\nAlaska Native") %>% select(share) %>% pull()
aian_education_2021 <- data %>% filter(concept=="Educational Attainment" & year=="2021" & race=="American Indian and\nAlaska Native") %>% select(share) %>% pull()

white_education_2015 <- data %>% filter(concept=="Educational Attainment" & year=="2015" & race=="white") %>% select(share) %>% pull()
white_education_2021 <- data %>% filter(concept=="Educational Attainment" & year=="2021" & race=="white") %>% select(share) %>% pull()

aian_ratio_2015 <- aian_education_2015/white_education_2015
aian_ratio_2021 <- aian_education_2021/white_education_2021

aian_education <- prettyNum(round(aian_education_2021*100,0), big.mark = ",")
aian_education_share <- prettyNum(round(aian_ratio_2021*100,0), big.mark = ",")

educational_attainment_chart <- create_static_column_chart(t = data %>% filter(concept == "Educational Attainment"),
                                                           x = "race", y = "share", fill = "year",
                                                           title = "Share of the Population With at Least a Bachelors Degree",
                                                           source = paste("Source: U.S. Census Bureau, ACS 1-Year Estimates, tables C15002H, C15002C",
                                                                          "for King, Kitsap, Pierce and Snohomish counties.",
                                                                          sep = "\n"),
                                                           color = "pognbgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank())   

ggsave("educational_attainment_chart.png", educational_attainment_chart, width = 8, height = 6, dpi = 86)

```

\begin{flushleft}
Education unlocks opportunities to the highest income jobs and ensures that people have the chance to benefit from the PSRC region's strong economy. In order to compete for high-tech jobs in the region, people increasingly need at least a Bachelor's Degree. The percentage of American Indian and Alaska Native people with a least a Bachelor's Degree has increased since 2015 to approximately `r aian_education`\% in 2021 however like income metrics it is significantly lower (`r aian_education_share`\%) than the rates of white residents with at least a Bachelor's Degree. Disparities in funding for schools, access to Science, Technology, Engineering and Math (STEM) programs continue to provide barriers to economic growth for American Indian and Alaska Native people.
\end{flushleft}

\pdftooltip{\includegraphics{educational_attainment_chart.png}}{People with at least a Bachelors Degree for people who identify as American Indian and Alaska Native or white}

## Disparities in Home Ownership

```{r home-ownership-calculation, include=FALSE}

aian_ownership_2015 <- data %>% filter(concept=="Home Ownership" & year=="2015" & race=="American Indian and\nAlaska Native") %>% select(share) %>% pull()
aian_ownership_2021 <- data %>% filter(concept=="Home Ownership" & year=="2021" & race=="American Indian and\nAlaska Native") %>% select(share) %>% pull()

white_ownership_2015 <- data %>% filter(concept=="Home Ownership" & year=="2015" & race=="white") %>% select(share) %>% pull()
white_ownership_2021 <- data %>% filter(concept=="Home Ownership" & year=="2021" & race=="white") %>% select(share) %>% pull()

aian_ratio_2015 <- aian_ownership_2015/white_ownership_2015
aian_ratio_2021 <- aian_ownership_2021/white_ownership_2021

aian_ownership <- prettyNum(round(aian_ownership_2021*100,0), big.mark = ",")
aian_ownership_share <- prettyNum(round(aian_ratio_2021*100,0), big.mark = ",")

aian_ownership_15 <- prettyNum(round(aian_ownership_2015*100,0), big.mark = ",")
aian_ownership_share_15 <- prettyNum(round(100-(aian_ratio_2015*100),0), big.mark = ",")

home_ownership_chart <- create_static_column_chart(t = data %>% filter(concept=="Home Ownership"),
                                                   x = "race", y = "share", fill = "year",
                                                   title = "Share of Households That own Their Home",
                                                   source = paste("Source: U.S. Census Bureau, ACS 1-Year Estimates, Tables B25003H, B25003C",
                                                                  "for King, Kitsap, Pierce and Snohomish counties.",
                                                                  sep = "\n"),
                                                   color = "gnbopgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank())  

ggsave("home_ownership_chart.png", home_ownership_chart, width = 8, height = 6, dpi = 86)

```

\begin{flushleft}
Home ownership is a key to wealth in the United States. For decades, lending practices have benefited white people and have led to large wealth disparities between people of color and white households. As home values sky-rocket, access to low-rate mortgages are a key to affording a home. In 2015 an American Indian and Alaska Native household was `r aian_ownership_share_15`\% less likely to own their own home than a white household. By 2021, with rapidly rising home values pricing out many, the home ownership rate for American Indian and Alaska Native households dropped slightly to `r aian_ownership`\%.
\end{flushleft}

\pdftooltip{\includegraphics{home_ownership_chart.png}}{Percentage of households that own their own home for people who identify as American Indian and Alaska Native or white}

```{r home-value-calculation, include=FALSE}

aian_value_2015 <- data %>% 
  filter(concept=="Median Home Value" & year=="2015" & race=="American Indian and\nAlaska Native") %>% select(estimate) %>% pull() %>% as.integer()

aian_value_2020 <- data %>% 
  filter(concept=="Median Home Value" & year=="2020" & race=="American Indian and\nAlaska Native") %>% select(estimate) %>% pull() %>% as.integer()

white_value_2015 <- data %>% filter(concept=="Median Home Value" & year=="2015" & race=="white") %>% select(estimate) %>% pull() %>% as.integer()
white_value_2020 <- data %>% filter(concept=="Median Home Value" & year=="2020" & race=="white") %>% select(estimate) %>% pull() %>% as.integer()

aian_ratio_2015 <- aian_value_2015/white_value_2015
aian_ratio_2020 <- aian_value_2020/white_value_2020

white_ratio_2020 <- prettyNum(round((white_value_2020/white_value_2015)*100,0), big.mark = ",")

aian_value <- prettyNum(round(aian_value_2020,-2), big.mark = ",")
aian_value_share <- prettyNum(round(100-(aian_ratio_2020*100),0), big.mark = ",")

aian_value_15 <- prettyNum(round(aian_value_2015,0), big.mark = ",")
aian_value_share_15 <- prettyNum(round(100-(aian_ratio_2015*100),0), big.mark = ",")

# Arrange by Race
tbl <- data %>% filter(concept=="Median Home Value") %>% arrange(desc(race))
tbl_order <- tbl %>% select(race) %>% distinct %>% pull()
tbl <- tbl %>% mutate(race = factor(x=race, levels=tbl_order))

home_value_chart <- create_static_bar_chart(t = tbl,
                                            x = "race", y = "estimate", fill = "year", est = "currency", dec = -3,
                                            title = "Average Home Value",
                                            source = paste("Source: U.S. Census Bureau, Public Use Microdata Sample 5-Year Estimates, variable VALP",
                                                           "for King, Kitsap, Pierce and Snohomish counties.",
                                                           sep = "\n"),
                                            color = "pgnobgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 axis.text.x = ggplot2::element_blank(),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.title.position = "plot",
                 plot.caption.position = "plot",
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_blank(),
                 axis.line.y = ggplot2::element_line(color="#cbcbcb"))

ggsave("home_value_chart.png", home_value_chart, width = 8, height = 6, dpi = 86)

```

\begin{flushleft}
Home ownership, and the wealth afforded by it to home owners, has increased dramatically over the past five years in Central the Puget Sound Region. The average value of a home owned by a white household increased by approximately `r white_ratio_2020`\% since 2015, unlocking opportunities through refinancing or home sale to increase household wealth. The value in homes owned by American Indian and Alaska Native households has also increased significantly over the past five years however the average value of a home owned by an American Indian and Alaska Native household was still `r aian_value_share`\% lower than the average home value for a white household. Lower home values, combined with lower ownership rates and more difficulty obtaining low-interest loans creates furtehr wealth disparities for American Indian and Alaska Native households.
\end{flushleft}

\pdftooltip{\includegraphics{home_value_chart.png}}{Average Home Value for people who identify as American Indian and Alaska Native or white who own their own home}

## Health Disparities

```{r health-insurance-calculation, include=FALSE}

aian_insurance_2015 <- data %>% filter(concept=="Health Insurance" & year=="2015" & race=="American Indian and\nAlaska Native") %>% select(share) %>% pull()
aian_insurance_2021 <- data %>% filter(concept=="Health Insurance" & year=="2021" & race=="American Indian and\nAlaska Native") %>% select(share) %>% pull()

white_insurance_2015 <- data %>% filter(concept=="Health Insurance" & year=="2015" & race=="white") %>% select(share) %>% pull()
white_insurance_2021 <- data %>% filter(concept=="Health Insurance" & year=="2021" & race=="white") %>% select(share) %>% pull()

aian_ratio_2015 <- aian_insurance_2015/white_insurance_2015
aian_ratio_2021 <- aian_insurance_2021/white_insurance_2021

aian_insurance <- prettyNum(round(aian_insurance_2021*100,0), big.mark = ",")
aian_insurance_share <- prettyNum(round(aian_ratio_2021,1), big.mark = ",")

health_insurance_chart <- create_static_column_chart(t = data %>% filter(concept=="Health Insurance"),
                                                     x = "race", y = "share", fill = "year",
                                                     title = "People Without Health Insurance",
                                                     source = paste("Source: U.S. Census Bureau, ACS 1-Year Estimates, tables C27001H, C27001C",
                                                                    "for King, Kitsap, Pierce and Snohomish counties.",
                                                                    sep = "\n"),
                                                     color = "obgnpgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank()) 

ggsave("health_insurance_chart.png", health_insurance_chart, width = 8, height = 6, dpi = 86)
  
```

\begin{flushleft}
Access to affordable health care is key to ensuring positive health outcomes. When people lack access to health insurance they are less likely to visit the doctor for routine care, remain current on vaccinations and receive preventive screenings that can catch health issues early where they can still be treatable. American Indian and Alaska Native residents are `r aian_insurance_share` times more likely to lack health insurance than white residents.
\end{flushleft}

\pdftooltip{\includegraphics{health_insurance_chart.png}}{People without Health Insurance for people who identify as American Indian and Alaska Native or white}

```{r life-expectancy-calculation, include=FALSE}

aian_life_2019 <- data %>% filter(concept=="Life Expectancy" & year=="2019" & race=="American Indian and\nAlaska Native") %>% select(estimate) %>% pull()
aian_life_2020 <- data %>% filter(concept=="Life Expectancy" & year=="2020" & race=="American Indian and\nAlaska Native") %>% select(estimate) %>% pull()

white_life_2019 <- data %>% filter(concept=="Life Expectancy" & year=="2019" & race=="white") %>% select(estimate) %>% pull()
white_life_2020 <- data %>% filter(concept=="Life Expectancy" & year=="2020" & race=="white") %>% select(estimate) %>% pull()

aian_life_2020_value <- prettyNum(round(aian_life_2020,1), big.mark = ",")
aian_life_delta <- prettyNum(round(white_life_2020-aian_life_2020,1), big.mark = ",")

aian_life_delta_covid <- prettyNum(round(aian_life_2019-aian_life_2020,1), big.mark = ",")
white_life_delta_covid <- prettyNum(round(white_life_2019-white_life_2020,1), big.mark = ",")

life_expectancy_chart <- create_static_line_chart(t = data %>% filter(concept=="Life Expectancy"), 
                                                  x = "year", y = "estimate", fill = "race", est = "number", dec=1,
                                                  title = "Average Life Expectancy at Birth",
                                                  source = paste("Source: Washington State Department of Health, Center for Health Statistics,",
                                                                 "Death Certificate Data 2020, Community Health Assessment Tool (Chat), December 2021",
                                                                 sep = "\n"),
                                                  xtype="Continuous", dform="%b-%Y", 
                                                  breaks=c("2005","2010","2015","2020"), 
                                                  lwidth=2, color="gnbopgy_5") +
    ggplot2::theme(axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.title.position = "plot",
                 plot.caption.position = "plot",
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_line(color="#cbcbcb"))

ggsave("life_expectancy_chart.png",life_expectancy_chart, width = 8, height = 5, dpi = 96)
  
```

```{r infant-mortality-calculation, include=FALSE}

aian_infant_2020 <- data %>% filter(concept=="Infant Mortality" & year=="2020" & race=="American Indian and\nAlaska Native") %>% select(estimate) %>% pull()
white_infant_2020 <- data %>% filter(concept=="Infant Mortality" & year=="2020" & race=="white") %>% select(estimate) %>% pull()

aian_infant_2020_value <- prettyNum(round(aian_infant_2020,1), big.mark = ",")
aian_infant_delta <- prettyNum(round(aian_infant_2020/white_infant_2020,1), big.mark = ",")

infant_mortality_chart <- create_static_line_chart(t = data %>% filter(concept=="Infant Mortality"), 
                                                  x = "year", y = "estimate", fill = "race", est = "number", dec=1,
                                                  title = "Average 5yr Infant Mortality Rate per 1000 Live Births",
                                                  source = paste("Source: Washington State Department of Health, Center for Health Statistics,",
                                                                 "Birth & Death Certificate Data 2020, Community Health Assessment Tool (Chat), December 2021",
                                                                 sep = "\n"),
                                                  xtype="Continuous", dform="%b-%Y", 
                                                  breaks=c("2008", "2010", "2012", "2014", "2016", "2018", "2020"), 
                                                  lwidth=2, color="pognbgy_5") +
    ggplot2::theme(axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.title.position = "plot",
                 plot.caption.position = "plot",
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_line(color="#cbcbcb"))

ggsave("infant_mortality_chart.png",infant_mortality_chart, width = 8, height = 5, dpi = 96)
  
```

\begin{flushleft}
The average life expectancy for American Indian and Alaska Native people in 2020 was `r aian_life_2020_value` years, `r aian_life_delta` years less than white people. The COVID-19 pandemic impacted the average life expectancy for all people regardless of race and ethnicity however the impacts show very clear racial disparities. For American Indian and Alaska Native people, the COVID-19 pandemic reduced the average expected life span by `r aian_life_delta_covid` years, almost three times greater than the reduction for white people(`r white_life_delta_covid` years).

\hfill\break
Lack of access to health insurance also has clear impacts on infant mortality which is calculated by comparing the number of live births in a given year with the number of deaths for infants within their first year of life. The long-term trends for infant mortality are encouraging for American Indian and Alaska Native infants but the rate of infant deaths per 1000 live births for American Indian and Alaska Native infants (`r aian_infant_2020_value` deaths per 1000 births) is still `r aian_infant_delta` times higher than the rate for white infants.
\end{flushleft}

\pdftooltip{\includegraphics{life_expectancy_chart.png}}{Life expectancy for people who identify as American Indian and Alaska Native or white}

\hfill\break

\pdftooltip{\includegraphics{infant_mortality_chart.png}}{Five year average Infant mortality rate per 1000 live births for people who identify as American Indian and Alaska Native or white}

## Advancing Racial Equity
\begin{flushleft}
The region's vision for 2050 is to provide exceptional quality of life, opportunity for all, connected communities, a spectacular natural environment, and an innovative, thriving economy. This cannot be achieved without dismantling systems of racial inequity.  

\hfill\break
This data doesn’t easily reveal the varied experiences different ethnic groups within the American Indian and Alaska Native community have in the region and how it shapes where they live, the opportunities they can access and the trajectory of their lives. However, it does highlight the need to address the unique barriers these communities face that depress their incomes and disproportionately push them into poverty and lead to significant disparities for health.

\hfill\break
“One-size-fits-all” strategies are rarely successful. Rather than seeking to establish policies and practices where everyone is treated the same, PSRC is establishing universal goals while considering how different groups have faced, and continue to face, different barriers. The agency recognizes that other groups of people are still marginalized based on gender, sexual orientation, ability, and age, etc. Focusing on racial equity provides the opportunity to address the unique circumstances of various racial groups and recognizes the interconnected ways in which marginalization takes place.

\hfill\break
PSRC is working to advance opportunities for people of American Indian and Alaska Native heritage through its Equity Advisory Committee. The group is helping PSRC develop a Regional Equity Strategy and advise PSRC on policies and programs with an equity lens that can help lessen these disparities as we move forward. The committee meets monthly and the next meeting is scheduled on Thursday December 1, 2022 from 5:30 - 7:30pm.

\hfill\break
\href{https://www.psrc.org/media/7082}{\underline{\textcolor{blue}{Click here to Download the Data used in this Trend}}} 

\end{flushleft}

```{r create-final-data-file, include=FALSE}

concepts <- data %>% select(concept) %>% pull() %>% unique()

wb <- createWorkbook()
i <- 1
for (c in concepts) {
  
  temp <- data %>% filter(concept==c)
  
  addWorksheet(wb = wb, sheetName = c, gridLines = FALSE)
  writeDataTable(wb = wb, sheet = i, x = temp)
  i <- i+1
  
  rm(temp)
  
}

## setup a workbook with 3 worksheets

saveWorkbook(wb=wb, file=xlsx_file, overwrite = TRUE)


```

