---
output: 
  pdf_document:
    latex_engine: lualatex
fontsize: 12pt
  
header-includes:
  - \usepackage{xcolor}
  - \usepackage{hyperref}
  - \usepackage{pdfcomment}
  - \usepackage{fancyhdr}
   \pagestyle{fancy}
   \setlength{\headheight}{75pt}
   \setlength{\textheight}{600pt}
   \fancyhead[C]{}
   \fancyhead[L]{\includegraphics{X:/DSA/shiny-uploads/images/PST_Equity_Edition-Trend_header.png}}
   \fancyhead[R]{}
   \fancyfoot[C]{\scriptsize{1011 Western Ave, Suite 500, Seattle WA 98104} \textcolor[HTML]{F05A28}. 206.464.7532 \textcolor[HTML]{F05A28}. www.psrc.org \textcolor[HTML]{F05A28}. November 2022}
   \fancyfoot[R]{\textcolor[HTML]{F05A28}\thepage}
   \fancyfoot[L]{}
   \renewcommand{\headrulewidth}{0pt}
   \renewcommand{\footrulewidth}{4pt}
   \renewcommand{\footrule}{\hbox to \headwidth{\color[HTML]{BCBEC0}\leaders\hrule height \footrulewidth\hfill}}
  - \usepackage{fontspec}

---
\setmainfont{Poppins}

# Celebrating Native American Heritage Month

```{r setup, include=FALSE}
library(psrcplot)
library(psrccensus)
library(tidyverse)
library(knitr)
library(magick)

# Create Image 
image1 <- image_read("X:/DSA/shiny-uploads/images/51391430801_092ce43bba_o.jpg")
image2 <- image_read("X:/DSA/shiny-uploads/images/Indigenous_Peoples_Day_Art.jpg")
image3 <- image_read("X:/DSA/shiny-uploads/images/51391685878_3179b31fd1_o.jpg")

input <- c(image_scale(image1, "x200"), image_scale(image2, "x200"), image_scale(image3, "x200"))

trend_image_header <- image_append(input)
image_write(trend_image_header, path="trend_image_header.png", format="png")

install_psrc_fonts()

create_static_column_chart <- function(t, x, y, fill,
                                       pos="dodge", est="percent", moe=NULL,
                                       href=NULL, hrefnm=NULL, hrefcl=NULL,
                                       title="", subtitle="", source="", alt="", 
                                       dec = 0, color="psrc_dark") {
  
  # Determine the Maximum Value to ensure bar labels are not cut-off
  max_item <- t %>% dplyr::select(.data[[y]]) %>% pull() %>% max()
  
  # Create a color palette from PSRC palette
  grps <- t %>% dplyr::select(.data[[fill]]) %>% unique() %>% dplyr::pull()
  num.grps <- length(grps)
  l.colors <- unlist(psrcplot::psrc_colors[color])
  l.colors <- l.colors[1:num.grps]
  cols <- stats::setNames(l.colors, grps)
  
  # Estimate type determines the labels for the axis and the format of the number for the hover-text
  if (est=="percent") {
    scale_max <- max_item * 1.1
    fac=100
    p=""
    s="%"
    lab=scales::label_percent()
    annot = 0.01
    
  } else if (est=="currency") {
    scale_max <- max_item * 1.1
    fac=1
    p="$"
    s=""
    lab=scales::label_dollar()
    annot = 1
    
  } else {
    scale_max <- max_item * 1.1
    fac=1
    p=""
    s=""
    lab=scales::label_comma()
    annot = 1
  }
  
  # First Create the Static Chart
  c <- ggplot2::ggplot(data=t,
                       ggplot2::aes(x=get(eval(x)),
                                    y=get(eval(y)),
                                    text=paste0(get(eval(fill)), ": ", p, prettyNum(round(get(eval(y))*fac, dec), big.mark = ","),s),
                                    fill = get(eval(fill)))) +
    ggplot2::geom_bar(position=pos, stat="identity") +
    ggplot2::scale_fill_manual(values=cols)  +
    ggplot2::scale_y_continuous(labels = lab, limits = c(0, scale_max), expand = c(0, 0)) +
    #ggplot2::labs(title=expr(underline(!!title)), subtitle = subtitle, caption = source, alt = alt) +
    ggplot2::labs(title=title, subtitle = subtitle, caption = source, alt = alt) +
    psrcplot::psrc_style()
  
  # If there is a MOE value then error bars are added to the plot
  if (!(is.null(moe))) {
    c <- c + ggplot2::geom_errorbar(ggplot2::aes(ymin=get(eval(y))-get(eval(moe)), ymax=get(eval(y))+get(eval(moe))),width=0.2, position = ggplot2::position_dodge(0.9))
  }
  
  # Add Bar Labels if there is no Error Bar
  if (is.null(moe)) {
    c <- c + ggplot2::geom_text(aes(x=get(eval(x)), 
                                    y=get(eval(y)), 
                                    label=paste0(p,prettyNum(round(get(eval(y))*fac,dec), big.mark = ","),s)),
                                check_overlap = TRUE,
                                position = position_dodge(0.9),
                                vjust = -0.25,
                                size = 11*0.36,
                                family="Poppins")
  }
  
  # Add reference lines if they are included 
  if (!(is.null(href))) {
    c <- c + 
      ggplot2::geom_hline(yintercept = href, color=hrefcl, linetype='solid', size=2, show.legend = FALSE) +
      ggplot2::annotate("text", x = 1, y = href+annot, label = hrefnm)
  }
  
  if (num.grps == 1) {
    
    c <- c + ggplot2::theme(legend.position = "none")
    
  }
  
  c <- c + ggplot2::theme(

    #Text format:
    #This sets the font, size, type and color of text for the chart's title
    plot.title = ggplot2::element_text(family="Poppins",
                                       size=14),

    #This sets the font, size, type and color of text for the chart's subtitle, as well as setting a margin between the title and the subtitle
    plot.subtitle = ggplot2::element_text(family="Poppins",
                                          size=11,
                                          margin=ggplot2::margin(9,0,9,0)),

    #This leaves the caption text element empty, because it is set elsewhere in the finalise plot function
    plot.caption =  ggplot2::element_text(family="Poppins",
                                          size=10,
                                          face="italic",
                                          color="#4C4C4C"))

  return(c)
}

create_static_treemap_chart <- function(t, area, fill, title="", subtitle="", source="", alt="", est="percent", dec=0, color="psrc_light") {
  
  tot <- t %>% dplyr::select(.data[[area]]) %>% dplyr::pull() %>% sum()
  t <- t %>% dplyr::mutate(total_share = .data[[area]]/tot)
  
  # Estimate type determines the labels
  if (est=="percent") {
    factor=100
    p=""
    s="%"
    
  } else if (est=="currency") {
    factor=1
    p="$"
    s=""
    
  } else {
    factor=1
    p=""
    s=""
  }
  
  if (est=="percent") {
    c <- ggplot2::ggplot(t,
                         ggplot2::aes(area = get(eval(area)),
                                      fill = get(eval(fill)), 
                                      label = paste(get(eval(fill)), 
                                                    paste0(p, prettyNum(round(get(eval(area))*factor,dec), big.mark = ","), s),
                                                    sep = "\n"))) +
      treemapify::geom_treemap(colour = "white", size = 3) +
      treemapify::geom_treemap_text(colour = "white",
                                    place = "centre",
                                    size = 16,
                                    grow = FALSE) +
      psrc_style() +
      ggplot2::theme(legend.position = "none") +
      scale_fill_discrete_psrc(color) +
      ggplot2::labs(title=expr(underline(!!title)), subtitle = subtitle, caption = source, alt = alt)
    
  } else {
    
    c <- ggplot2::ggplot(t,
                         ggplot2::aes(area = get(eval(area)),
                                      fill = get(eval(fill)), 
                                      label = paste(get(eval(fill)), 
                                                    paste0(p, prettyNum(round(get(eval(area))*factor,dec), big.mark = ","), s),
                                                    #paste0(prettyNum(round(.data$total_share*100,0), big.mark = ","), "%"), 
                                                    sep = "\n"))) +
      treemapify::geom_treemap(colour = "white", size = 3) +
      treemapify::geom_treemap_text(colour = "white",
                                    place = "centre",
                                    size = 16,
                                    grow = FALSE) +
      psrc_style() +
      ggplot2::theme(legend.position = "none") +
      scale_fill_discrete_psrc(color) +
      #ggplot2::labs(title=expr(underline(!!title)), subtitle = subtitle, caption = source, alt = alt) +
      ggplot2::labs(title=title, subtitle = subtitle, caption = source, alt = alt)
    
  }
  
    c <- c + ggplot2::theme(

    #Text format:
    #This sets the font, size, type and color of text for the chart's title
    plot.title = ggplot2::element_text(family="Poppins",
                                       size=14),

    #This sets the font, size, type and color of text for the chart's subtitle, as well as setting a margin between the title and the subtitle
    plot.subtitle = ggplot2::element_text(family="Poppins",
                                          size=11,
                                          margin=ggplot2::margin(9,0,9,0)),

    #This leaves the caption text element empty, because it is set elsewhere in the finalise plot function
    plot.caption =  ggplot2::element_text(family="Poppins",
                                          size=10,
                                          face="italic",
                                          color="#4C4C4C"))
  
  return(c)
}

# Load Data or Generate if not already processed
if(file.exists("aian_hertitage_data.csv")) {
  data <- read.csv("aian_hertitage_data.csv") %>% mutate(year=as.character(year)) %>% mutate(race = str_wrap(race, width = 20))
} else {
  source("data-processing.R")
  data <- read.csv("aian_hertitage_data.csv") %>% mutate(year=as.character(year)) %>% mutate(race = str_wrap(race, width = 20))
}

# Rename a few items
data <- data %>% 
  mutate(race = str_replace_all(race, "White", "white")) %>%
  mutate(label = str_replace_all(label, "All other American Indian Tribes with only one Tribe reported", "All Other Tribes with only one Tribe reported")) %>%
  mutate(label = str_replace_all(label, "American Indian and Alaska Native Tribes where Tribe Not Specified", "Tribe Not Specified")) %>%
  mutate(label = str_replace_all(label, "American Indian Tribes with fewer than 1000 people", "Tribes with fewer than 1000 people")) %>%
  mutate(label = str_replace_all(label, "Two or More American Indian and Alaska Native Tribes", "Two or More Tribes"))

```

![](trend_image_header.png){width=100%}

```{r tribal-groupings-calculation, include=FALSE}

tbl <- data %>%
  filter(concept=="Tribal Groupings" & year=="2020") %>%
  arrange(desc(estimate)) %>%
  mutate(label=str_wrap(label,width=20))
  
tbl_order <- tbl %>% select(label) %>% pull()
tbl <- tbl %>% mutate(label = factor(x=label, levels=tbl_order))

ps_salish <- tbl %>% filter(label=="Puget Sound Salish") %>% select(estimate) %>% pull()

# Create Visuals
tribal_groupings_chart <- create_static_treemap_chart(t = tbl, area="estimate", fill="label", est="number", dec=-1,
                                                      title = "Tribal Groupings With 1,000 or More Population",
                                                      source = paste("Source: U.S. Census Bureau, 2016-2020 ACS 5-Year Estimates, Table B02014",
                                                                     "for King, Kitsap, Pierce and Snohomish counties.",
                                                                    sep = "\n"),
                                                      color = "gnbopgy_10") + 
  ggplot2::theme(axis.text.x = ggplot2::element_blank(),
                 axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank(),
                 legend.text = ggplot2::element_text(family="Poppins",
                                        size=10,
                                        color="#4C4C4C")) 

ggsave("tribal_groupings_chart.png", tribal_groupings_chart, width = 8, height = 5, dpi = 96)

rm(tbl)
```

\begin{flushleft}
This month, PSRC delves into data on the region’s American Indian and Alaska Native population. People with First Nations heritage in our region are very diverse, with over 50 Tribal groups represented. About \textbf{`r toString(prettyNum(round(ps_salish,-2), big.mark = ","))`} of the region’s residents identify as Puget Sound Salish. The American Community Survey groups Tribes who have original homelands in the four-county region under the name Puget Sound Salish. The region’s second most common Tribal grouping is Tlingit-Haida, who are Alaska Native peoples. 
\end{flushleft}

\pdftooltip{\includegraphics{tribal_groupings_chart.png}}{Number of people by Tribal Grouping with more than 1000 people in the Puget Sound Region}

\begin{flushleft}
\href{https://data.census.gov/cedsci/table?q=B02014&g=0500000US53033,53035,53053,53061&tid=ACSDT5Y2020.B02014&hidePreview=true}{\underline{\textcolor{blue}{View the full data set here}}}

PSRC celebrates the diverse, rich cultures of people with American Indian and Alaska Native heritage. We also recognize the suffering that members of these groups have experienced in the past and continue to endure due to historical policies and practices.

Economic inequities persist for American Indian and Alaska Native residents. Disparities exist for home ownership, access to health care, educational opportunities and income.  
\end{flushleft}

## Median Income

```{r income-calculation, include=FALSE}

median_income_chart <- create_static_column_chart(t = data %>% filter(concept=="Median Income"),
                                                  x = "race", y = "estimate", fill = "year", est = "currency", dec = -2,
                                                  title = "Median Income",
                                                  source = paste("Source: U.S. Census Bureau, Public Use Microdata Sample 5-Year Estimates, variable HINCP",
                                                                 "for King, Kitsap, Pierce and Snohomish counties.",
                                                                 sep = "\n"),
                                                  color = "gnbopgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank()) 

ggsave("median_income_chart.png", median_income_chart, width = 8, height = 6, dpi = 86)
  
```

\begin{flushleft}
American Indian and Alaska Native residents have incomes that are half of white residents.
\end{flushleft}

\pdftooltip{\includegraphics{median_income_chart.png}}{Median Annual Household Income for people who identify as American Indian and Alaska Native or white}

\newpage

## Poverty

```{r poverty-calculation, include=FALSE}

poverty_chart <- create_static_column_chart(t = data %>% filter(concept == "Poverty"),
                                            x = "race", y = "share", fill = "year",
                                            title = "People Experiencing Poverty",
                                            source = paste("Source: U.S. Census Bureau, 2016-2020 ACS 5-Year Estimates, tables B17020H, B17020C", 
                                                           "for King, Kitsap, Pierce and Snohomish counties.",
                                                                          sep = "\n"),
                                            color = "gnbopgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank()) 

ggsave("poverty_chart.png", poverty_chart, width = 8, height = 6, dpi = 86)

```

\begin{flushleft}
The percent of American Indian and Alaska Native residents living in poverty has decreased in the past 5 years but is still three times the rate for white residents.
\end{flushleft}

\pdftooltip{\includegraphics{poverty_chart.png}}{People in poverty for people who identify as American Indian and Alaska Native or white}

\newpage

## Home Ownership

```{r home-ownership-calculation, include=FALSE}

home_ownership_chart <- create_static_column_chart(t = data %>% filter(concept=="Home Ownership"),
                                                   x = "race", y = "share", fill = "year",
                                                   title = "People who own Their Home",
                                                   source = paste("Source: U.S. Census Bureau, ACS 1-Year Estimates, Tables B25003H, B25003C",
                                                                  "for King, Kitsap, Pierce and Snohomish counties.",
                                                                  sep = "\n"),
                                                   color = "pgnobgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank())  

ggsave("home_ownership_chart.png", home_ownership_chart, width = 8, height = 6, dpi = 86)

```

\begin{flushleft}
The home ownership among American Indian and Alaska Native residents is a third lower than the rate for white residents.
\end{flushleft}

\pdftooltip{\includegraphics{home_ownership_chart.png}}{Share of households that own their own home for people who identify as American Indian and Alaska Native or white}

\newpage

## Home Value

```{r home-value-calculation, include=FALSE}

home_value_chart <- create_static_column_chart(t = data %>% filter(concept=="Median Home Value"),
                                                   x = "race", y = "estimate", fill = "year", est = "currency", dec = -2,
                                                   title = "Median Home Value",
                                                   source = paste("Source: U.S. Census Bureau, Public Use Microdata Sample 5-Year Estimates, variable VALP",
                                                                  "for King, Kitsap, Pierce and Snohomish counties.",
                                                                  sep = "\n"),
                                                   color = "pgnobgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank())  

ggsave("home_value_chart.png", home_value_chart, width = 8, height = 6, dpi = 86)

```

\begin{flushleft}
The value in homes owned by American Indian and Alaska Native residents is a third lower than the rate for white residents.
\end{flushleft}

\pdftooltip{\includegraphics{home_value_chart.png}}{Median Home Value for people who identify as American Indian and Alaska Native or white and own their own homes}

\newpage

## Educational Attainment

```{r educational-attainment-calculation, include=FALSE}

educational_attainment_chart <- create_static_column_chart(t = data %>% filter(concept == "Educational Attainment"),
                                                           x = "race", y = "share", fill = "year",
                                                           title = "People With at Least a Bachelors Degree",
                                                           source = paste("Source: U.S. Census Bureau, ACS 1-Year Estimates, tables C15002H, C15002C",
                                                                          "for King, Kitsap, Pierce and Snohomish counties.",
                                                                          sep = "\n"),
                                                           color = "pognbgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank())   

ggsave("educational_attainment_chart.png", educational_attainment_chart, width = 8, height = 6, dpi = 86)

```

\begin{flushleft}
The percent of American Indian and Alaska Native residents with a least a Bachelor's Degree has increased in the past 5 years but is still less than half the rate for white residents.
\end{flushleft}

\pdftooltip{\includegraphics{educational_attainment_chart.png}}{People with at least a Bachelors Degree for people who identify as American Indian and Alaska Native or white}

\newpage 
## Access to Health Insurance

```{r health-insurance-calculation, include=FALSE}

health_insurance_chart <- create_static_column_chart(t = data %>% filter(concept=="Health Insurance"),
                                                     x = "race", y = "share", fill = "year",
                                                     title = "People Without Health Insurance",
                                                     source = paste("Source: U.S. Census Bureau, ACS 1-Year Estimates, tables C27001H, C27001C",
                                                                    "for King, Kitsap, Pierce and Snohomish counties.",
                                                                    sep = "\n"),
                                                     color = "obgnpgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank()) 

ggsave("health_insurance_chart.png", health_insurance_chart, width = 8, height = 6, dpi = 86)
  
```

\begin{flushleft}
American Indian and Alaska Native residents are almost 4 times more likely to lack health insurance than white residents.
\end{flushleft}

\pdftooltip{\includegraphics{health_insurance_chart.png}}{People without Health Insurance for people who identify as American Indian and Alaska Native or white}

\newpage

## Life Expectancy

```{r life-expectancy-calculation, include=FALSE}

life_expectancy_chart <- create_static_column_chart(t = data %>% filter(concept=="Life Expectancy" & year %in% c("2015", "2020")),
                                                     x = "race", y = "estimate", fill = "year", est = "number", dec=1,
                                                     title = "Life Expectancy",
                                                     source = paste("Source: Washington State Department of Health, Center for Health Statistics,",
                                                                    "Death Certificate Data 2020, Community Health Assessment Tool (Chat), December 2021",
                                                                    sep = "\n"),
                                                     color = "obgnpgy_5") + 
  ggplot2::theme(axis.text.y = ggplot2::element_blank(),
                 axis.text = ggplot2::element_text(family="Poppins",
                                      size=11,
                                      color="#2f3030"),
                 panel.grid.major.x = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.x = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.caption = element_text(hjust=0),
                 axis.line.x = ggplot2::element_line(color="#cbcbcb"),
                 axis.line.y = ggplot2::element_blank()) 

ggsave("life_expectancy_chart.png",life_expectancy_chart, width = 8, height = 6, dpi = 86)
  
```

\begin{flushleft}
The average life expectancy for American Indian and Alaska Native residents are almost 10 years less than white residents.
\end{flushleft}

\pdftooltip{\includegraphics{life_expectancy_chart.png}}{Life expectancy for people who identify as American Indian and Alaska Native or white}




\newpage 


