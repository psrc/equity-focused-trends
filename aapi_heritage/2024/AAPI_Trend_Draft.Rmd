---
title: "AAPI Trend"
author: "Brandon Wong"
output: html_document
---

```{r, include=FALSE}
library(psrccensus)
library(psrcplot)
library(tidyverse)
library(ggplot2)
library(knitr)

# install psrccensus and get api key by going trough instructions on: https://psrc.github.io/psrccensus/articles/psrccensus.html
Sys.getenv("f888d08b4cf518d8a5f7d4eb1fa050abb015ba37")

# more information on PUMS data: https://www.census.gov/programs-surveys/acs/microdata/documentation.html
# 2022 5-year PUMS data dictionary: https://api.census.gov/data/2022/acs/acs5/pums/variables.html
```


```{r, include=FALSE}
# download 2022 5-year PUMS data with specified variables
pums_2022 <- get_psrc_pums(span = 5,
                           dyear = 2022,
                           level = "h",
                           vars = c("AGEP",  # Age
                                    "PRACE", # Race
                                    "RAC1P", # Recoded detailed race code
                                    "RAC2P", # Recoded detailed race code
                                    "TEN",   # Tenure
                                    "GRPIP", # Gross rent as a percentage of household income past 12 months
                                    "HINCP", # Household income
                                    "SOCP3",  # Job Occupation
                                    "WAGP"   # Wage or salary income the past 12 months
                                    )) %>%

# filter only AAPI renters
  filter(TEN=="Rented",
         # household race assigned to household
         PRACE %in% c("Asian alone","Native Hawaiian and Other Pacific Islander alone")) %>%
  
  mutate(race_aapi = case_when(PRACE %in% c("Asian alone","Native Hawaiian and Other Pacific Islander alone") ~ "Asian or Pacific Islander",
                               PRACE == "White alone" ~ "White alone",
                               TRUE ~ PRACE),
         rent_pct_income = factor(case_when(GRPIP < 30 ~"Less than 30 percent",
                                            between(GRPIP,30,50) ~ "Between 30 and 50 percent",
                                            GRPIP > 50 ~ "Greater than 50 percent",
                                            TRUE ~ "No rent paid"),
                                  levels=c("Greater than 50 percent",
                                           "Between 30 and 50 percent",
                                           "Less than 30 percent",
                                           "No rent paid"))) %>% 
  filter(race_aapi == "Asian or Pacific Islander")
  
```

```{r, include = FALSE, warning=FALSE}
# create crosstabs
df_pums <- pums_2022 %>% psrc_pums_count(., group_vars=c("PRACE","RAC2P","rent_pct_income"))
  
df_pums2 <- pums_2022 %>% psrc_pums_median(stat_var = "HINCP", group_vars = c("PRACE","RAC2P")) %>%
  filter(RAC2P != 'Total')

# earn_by_occ_median <- psrc_pums_median(pums_2022, stat_var="WAGP",group_vars= c('SOCP3'))%>%filter(COUNTY=='Region')


job_grp_race <- pums_2022 %>%
  psrc_pums_count(., group_vars=c("PRACE","RAC2P","SOCP3")) %>%
  filter(SOCP3!='Total')%>%filter(RAC2P!='Total')

job_race <- pums_2022 %>%
  psrc_pums_count(., group_vars=c("PRACE","SOCP3")) %>%
  filter(SOCP3!='Total')

top_10_occ <- job_race %>%
  slice_max(order_by = count, n = 10)

```


## Table 1
This table displays the ordered population count of each Asian population who are renting in the region

```{r, echo=FALSE, include=FALSE}
# what unit are the count numbers? what do they mean?
# Do we only want to look at renters?

# df[order(-df$var1)

race_population <- df_pums %>% filter(rent_pct_income=="Total") %>%
  select(RAC2P, count, count_moe) %>%
  rename("Asian Population" = RAC2P, "Total" = count, "Margin of Error" = count_moe)

race_population[order(-race_population$Total)]

kable(race_population)
```


## Plot 1

This plot displays Asian sub-groups who are cost burdened. This is defined by anyone paying 30% or more of their income for their rent expense.

```{r echo=FALSE, fig.height=15, fig.width=15, warning=FALSE}
# Making a Renter Cost Burden by Asian Sub-group stacked bar chart

cost_burdened <- df_pums %>% 
  filter(rent_pct_income =="Greater than 50 percent" | rent_pct_income =="Between 30 and 50 percent") %>%
  dplyr::mutate(perc = paste0(sprintf("%4.1f", share * 100), "%"))

ggplot(cost_burdened, aes(x = reorder(RAC2P, share, Ascending=TRUE), y=share, fill = rent_pct_income, label = round(share, 2))) + 
          geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin=share-share_moe, ymax=share + share_moe), position = "dodge") +
  geom_text(aes(label=perc), size = 5,  hjust = -0.1, size = 2, position = position_dodge(width = 1)) +
  labs(title="Renter Cost Burden by Asian Populations") +
  xlab("") +
  psrc_style() +
  scale_fill_manual(values = psrc_colors$pognbgy_10) +
  coord_flip()

# size = 5,  hjust = -0.5, size = 2, position = position_dodge(width = 1)

```


## Plot 2

This plot displays median household income by asian sub-group


```{r, echo=FALSE, fig.height=15, fig.width=15, warning=FALSE}

ggplot(df_pums2, aes(x = reorder(RAC2P, HINCP_median, Ascending=TRUE), y = HINCP_median, fill = RAC2P)) +
  geom_col() +
  geom_errorbar(aes(ymin=HINCP_median-HINCP_median_moe, ymax=HINCP_median + HINCP_median_moe), position = "dodge") +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  labs(title="Median Household Income by Asian Population") +
  ylab("Median Income") +
  xlab("") +
  psrc_style() +
  coord_flip()

```



## Plot 3
Most common jobs by in the region and the share of Asian populations within those jobs

```{r, fig.height=15, fig.width=15, warning=FALSE}
target <- c("one EAT-Cooks and Food Preparation Workers", "FIN-Financial Specialists", "EAT-Food and Beverage Serving Workers", "PRS-Motor Vehicle Operators", "MGR-Operations Specialties Managers", "ENG-Engineers", "MED-Healthcare Diagnosing or Treating Practitioners", "FIN-Business Operations Specialists", "MGR-Other Management Occupations", "CMM-Computer Specialists")

job_grp_race <- job_grp_race %>% filter(SOCP3 %in% target)

job_grp_race$SOCP3 = factor(job_grp_race$SOCP3, levels=target)

ggplot(job_grp_race, aes(x = SOCP3, y=share, fill = RAC2P, label = round(share, 2))) + 
  geom_bar(stat = "identity") +
  geom_text(size = 2, position = position_stack(vjust = 0.5)) +
  labs(title="Top 10 most Common Jobs for Asian Populations") +
  psrc_style() +
  theme(axis.text.x = element_text(vjust=1, hjust=1)) +
  coord_flip()
```

