---
title: "AAPI Trend"
author: "Brandon Wong"
output: html_document
---

```{r, include=FALSE}
source("aapi_trend2024.R")
```


```{r, include = FALSE, warning=FALSE}

# earn_by_occ_median <- psrc_pums_median(pums_2022, stat_var="WAGP",group_vars= c('SOCP3'))%>%filter(COUNTY=='Region')
tenure <- psrc_pums_count(df_pums, group_vars=c("PRACE","TEN"))
renter <- psrc_pums_count(df_pums_renter_aapi, group_vars=c("PRACE","RAC2P","rent_pct_income"))
# m_income <- psrc_pums_median(df_pums, "HINCP") %>% filter(RAC2P != 'Total')
tot_hh_count <- psrc_pums_count(df_pums, group_vars = "RAC2P") %>% filter(RAC2P != 'Total')

race_occ <- psrc_pums_count(df_pums, group_vars=c("PRACE","SOCP3", "SOCP5")) %>% filter(SOCP3!='Total')
# , group_vars = c("RAC2P")

job_grp_race <- pums_2022 %>%
  psrc_pums_count(., group_vars=c("PRACE","RAC2P","SOCP3")) %>%
  filter(SOCP3!='Total')%>%filter(RAC2P!='Total')

job_race <- pums_2022 %>%
  psrc_pums_count(., group_vars=c("PRACE","SOCP3")) %>%
  filter(SOCP3!='Total')

top_10_occ <- job_race %>%
  slice_max(order_by = count, n = 10)

```


## Table 1
This table displays the ordered population count of each Asian population who are renting in the region

```{r, echo=FALSE, include=FALSE}

race_population <- hh_count %>% select(RAC2P, count, count_moe) %>%
  rename("Asian Population" = RAC2P, "Total" = count, "Margin of Error" = count_moe)

race_population <- race_population[order(-race_population$Total)]

kable(race_population)
```


## Plot 1

This plot displays Asian sub-groups who are cost burdened. This is defined by anyone paying 30% or more of their income for their rent expense.

1. Decide where to make the cut off for aggregation
2. Why are my graphs not displaying all populations?
3. Possibly look into a relative reliability score?
4. Is it okay to only show data for renters? (some ethnicities are excluded)

```{r echo=FALSE, fig.height=15, fig.width=7, warning=FALSE}
# Making a Renter Cost Burden by Asian Sub-group stacked bar chart

cost_burdened <- renter %>% 
  filter(rent_pct_income =="Greater than 50 percent" | rent_pct_income =="Between 30 and 50 percent") %>%
  select(RAC2P, count, count_moe, share, share_moe) %>%
  group_by(RAC2P) %>%
  summarize(across(c(count, count_moe, share, share_moe), sum)) %>% # aggregates all numerical values based on race
  dplyr::mutate(perc = paste0(sprintf("%4.1f", share * 100), "%")) %>% # adds a percentage column to the cost burdened share
  left_join(race_population,by=c("RAC2P"="Asian Population"))

# Version 1 (ordered by Total Households)
ggplot(cost_burdened, aes(x = reorder(RAC2P, Total, Ascending=TRUE), y=share, label = round(share, 2))) + 
          geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin=share-share_moe, ymax=share + share_moe), position = "dodge") +
  geom_text(aes(label=perc), size = 5,  hjust = -0.1, size = 2, position = position_dodge(width = 1)) +
  labs(title="Renter Cost Burden by Asian Populations") +
  xlab("") +
  psrc_style() +
  scale_fill_manual(values = psrc_colors$pognbgy_10) +
  coord_flip()

# Version 2 (ordered by most cost burdened)
ggplot(cost_burdened, aes(x = reorder(RAC2P, share, Ascending=TRUE), y=share, label = round(share, 2))) + 
          geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin=share-share_moe, ymax=share + share_moe), position = "dodge") +
  geom_text(aes(label=perc), size = 5,  hjust = -0.1, size = 2, position = position_dodge(width = 1)) +
  labs(title="Renter Cost Burden by Asian Populations") +
  xlab("") +
  psrc_style() +
  scale_fill_manual(values = psrc_colors$pognbgy_10) +
  coord_flip()

# Table
cb_tbl <- cost_burdened %>% select(RAC2P, perc, Total) %>% 
  arrange(.,desc(Total)) %>% 
  rename("Race"=RAC2P, "Percentage Cost Burdened"=perc, "Total Households"=Total)
kable(cb_tbl)
```


## Plot 2

This plot displays median household income by Asian sub-group. However it is median household income for all tenure types

1. Should median household income focus on renters?
2. What does this graph look like with aggregated data?
3. add an asian alone bar and 
4. below poverty line 

```{r, echo=FALSE, fig.height=15, fig.width=15, warning=FALSE}
# version 1 (ordered by Total Households)
m_inc <- m_income %>% left_join(tot_hh_count,by=c("RAC2P"="RAC2P"))

# version 1 (ordered by Total Households)
ggplot(m_inc, aes(x = reorder(RAC2P, count, Ascending=TRUE), y = HINCP_median, fill = RAC2P)) +
  geom_col() +
  geom_errorbar(aes(ymin=HINCP_median-HINCP_median_moe, ymax=HINCP_median + HINCP_median_moe), position = "dodge") +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  labs(title="Median Household Income by Asian Population") +
  ylab("Median Income") +
  xlab("") +
  psrc_style() +
  coord_flip()  

# version 2 (ordered by median income)
ggplot(m_income, aes(x = reorder(RAC2P, HINCP_median, Ascending=TRUE), y = HINCP_median, fill = RAC2P)) +
  geom_col() +
  geom_errorbar(aes(ymin=HINCP_median-HINCP_median_moe, ymax=HINCP_median + HINCP_median_moe), position = "dodge") +
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  labs(title="Median Household Income by Asian Population") +
  ylab("Median Income") +
  xlab("") +
  psrc_style() +
  coord_flip()

# Table
m_inc_tbl <- m_inc %>% select(RAC2P, HINCP_median, count) %>%
  arrange(.,desc(count)) %>%
  dplyr::mutate(HINCP_median = paste0("$", sprintf("%4.2f", HINCP_median * 1))) %>%
  rename("Race"=RAC2P, "Median Income"=HINCP_median, "Total Households"=count)
kable(m_inc_tbl)
  
```



## Plot 3
Most common jobs by in the region and the share of Asian populations within those jobs
filter for renter cost burden before their occupation

1. How should I determine job sectors to use? (between SOC3P, SOC5P) how do I make the occupations look nice?
2. Should this only be for renters?
3. create a facet chart by occupation

```{r, fig.height=15, fig.width=15, warning=FALSE}
target <- c("one EAT-Cooks and Food Preparation Workers", "FIN-Financial Specialists", "EAT-Food and Beverage Serving Workers", "PRS-Motor Vehicle Operators", "MGR-Operations Specialties Managers", "ENG-Engineers", "MED-Healthcare Diagnosing or Treating Practitioners", "FIN-Business Operations Specialists", "MGR-Other Management Occupations", "CMM-Computer Specialists")

job_grp_race <- job_grp_race %>% filter(SOCP3 %in% target)

job_grp_race$SOCP3 = factor(job_grp_race$SOCP3, levels=target)

ggplot(job_grp_race, aes(x = SOCP3, y=share, fill = RAC2P, label = round(share, 2))) + 
  geom_bar(stat = "identity") +
  geom_text(size = 2, position = position_stack(vjust = 0.5)) +
  labs(title="Top 10 most Common Jobs for Asian Populations") +
  psrc_style() +
  theme(axis.text.x = element_text(vjust=1, hjust=1)) +
  coord_flip()
```

